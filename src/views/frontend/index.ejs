<!-- 팝업 배너 -->
<% if (data?.popupBanner?.length > 0) { %>
  <div id="popupContainer" class="fixed inset-0 z-50 flex items-center justify-center gap-4 bg-black/50">
    <% data.popupBanner.forEach((popup) => { %>
      <div id="popupBanner<%=popup.id%>" class="flex flex-col items-end space-y-2 hidden" data-popup-id="<%=popup.id%>">
        <button class="popup-close-btn text-white cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        
        <div class="bg-white shadow-[0_2px_30px_rgba(0,0,0,.06)] w-[480px] h-[620px] p-2">
          <img 
            class="object-center object-cover w-full h-full" src="<%=popup.imagePath%>" alt="<%=popup.description%>" />
        </div>
      
        <div class="flex items-center mb-6">
          <input type="checkbox" id="todayCheck" class="mr-2">
          <label for="todayCheck" class="text-sm text-white">오늘 하루 보지 않기</label>
        </div>
      </div>
    <% }) %>
  </div>
<% } %>

<!-- 상단 배너 -->
<div class="relative h-screen w-full pt-[56px] lg:h-[800px]">
  <div class="absolute inset-0 -z-10 h-full w-full">
    <div class="absolute inset-0 h-full w-full bg-black opacity-50"></div>
    <% if (Object.keys(data?.topBanner || {}).length > 0) { %>
      <img class="relative h-full w-full -z-10 object-cover object-center" src="<%=data.topBanner.imagePath%>" alt="<%-data.topBanner.description%>" />
    <% } %>
  </div>
  <div class="m-auto h-full w-full max-w-[1280px] px-10">
    <div class="flex h-full flex-col items-center justify-center gap-8 py-20">
      <p class="mb-2 text-center break-keep text-white">
        <span class="font-tertiary text-2xl lg:text-[48px]">
          <strong><%-data.topBanner.title%></strong>
        </span>
      </p>
      <p class="text-center text-base font-semibold break-keep text-white lg:text-xl">
        <%-data.topBanner.description%>
      </p>
      <button
        id="contactBtn"
        class="flex cursor-pointer items-center rounded-full bg-[#0c0c0c] px-6 py-3 text-sm font-semibold text-white lg:text-[15px]"
      >
        <span>무료 상담하기</span>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" class="ml-2 h-3 w-3">
          <path
            d="M347.1 24.6c7.7-18.6 28-28.5 47.4-23.2l88 24C499.9 30.2 512 46 512 64c0 247.4-200.6 448-448 448c-18 0-33.8-12.1-38.6-29.5l-24-88c-5.3-19.4 4.6-39.7 23.2-47.4l96-40c16.3-6.8 35.2-2.1 46.3 11.6L207.3 368c70.4-33.3 127.4-90.3 160.7-160.7L318.7 167c-13.7-11.2-18.4-30-11.6-46.3l40-96z"
          />
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- 법률 사무소에서는 -->
<div class="w-full">
  <div class="m-auto h-full w-full max-w-[1280px] px-4 py-10 lg:px-10 lg:py-20">
    <div class="flex items-end justify-between border-b border-black pb-6 lg:pb-10">
      <h3 class="text-2xl font-semibold lg:text-[36px]">
        <p><%=company.name%></p>
        <p>법률 사무소에서는</p>
      </h3>
      <div class="flex-none">
        <button id="aboutBtn" class="cursor-pointer border border-black bg-white px-6 py-3 text-xs font-semibold">
          전체보기
        </button>
      </div>
    </div>
    <div class="lg:pl-50">
      <div class="flex flex-wrap justify-end gap-y-5 py-6 lg:gap-0 lg:py-10">
        <div class="flex-[50%] space-y-2.5 lg:flex-1 lg:px-4">
          <p class="text-base font-semibold lg:text-lg">24시간</p>
          <p class="text-sm text-wrap break-keep text-zinc-400 lg:text-base">언제 어디서나 간단히</p>
        </div>
        <div class="flex-[50%] space-y-2.5 lg:flex-1 lg:px-4">
          <p class="text-base font-semibold lg:text-lg">무료상담</p>
          <p class="text-sm text-wrap break-keep text-zinc-400 lg:text-base">부담없이 편한 마음으로</p>
        </div>
        <div class="flex-[50%] space-y-2.5 lg:flex-1 lg:px-4">
          <p class="text-base font-semibold lg:text-lg">담당변호사</p>
          <p class="text-sm text-wrap break-keep text-zinc-400 lg:text-base">풍부한 경험의 베테랑</p>
        </div>
        <div class="flex-[50%] space-y-2.5 lg:flex-1 lg:px-4">
          <p class="text-base font-semibold lg:text-lg">프로세스</p>
          <p class="text-sm text-wrap break-keep text-zinc-400 lg:text-base">체계적이고 확실한 도움</p>
        </div>
        <div class="flex-[50%] space-y-2.5 lg:flex-1 lg:px-4">
          <p class="text-base font-semibold lg:text-lg">정당한 보상</p>
          <p class="text-sm text-wrap break-keep text-zinc-400 lg:text-base">
            풍부한 경험을 바탕으로 최고의 보상을 기대
          </p>
        </div>
      </div>
      <div class="h-[150px] w-full lg:h-[450px]">
        <img src="<%=data.midBanner1.imagePath%>" alt="<%=data.midBanner1.description%>" class="h-full w-full object-cover" />
      </div>
    </div>
  </div>
</div>

<!-- 다양한 법률 서비스 -->
<% if (data.midBanner2.length !== 0) { %>
<div class="w-full bg-sky-50">
  <div class="m-auto h-full w-full max-w-[1280px] px-4 py-10 lg:px-10 lg:py-20">
    <div class="flex items-end justify-between pb-6 lg:pb-10">
      <h3 class="text-2xl font-semibold lg:text-[36px]">
        <p>다양한</p>
        <p>법률 서비스</p>
      </h3>
      <div class="flex-none">
        <button id="servicesBtn" class="cursor-pointer border border-black bg-white px-6 py-3 text-xs font-semibold">
          전체보기
        </button>
      </div>
    </div>
    <div class="lg:pl-50">
      <div id="mainServices" class="swiper h-[475px] lg:h-[550px]">
        <div class="swiper-wrapper">
        <% data.midBanner2.forEach((banner, index) => { %>
          <div
            class="swiper-slide cursor-pointer" 
          >
            <div class="absolute inset-0 -z-10">
              <div class="absolute inset-0 bg-black opacity-50"></div>
              <img class="relative h-full w-full -z-10 object-cover" src="<%=banner.imagePath%>" alt="<%=banner.title%>" />
            </div>
            <div class="flex h-full w-full flex-col justify-between p-8">
              <div class="flex items-center justify-between">
                <div class="mr-10 w-full border-2 border-b border-white"></div>
                <p class="font-['Oswald'] text-2xl font-semibold text-white"><%=String(index + 1).padStart(2, '0')%></p>
              </div>
              <p class="w-[50%] text-2xl font-semibold text-wrap break-keep text-white"><%=banner.title%></p>
            </div>
          </div>
        <% }) %>
        </div>
      </div>
    </div>
  </div>
</div>
<% } %>

<!-- 서비스 성공 사례 -->
<% if (data.midBanner3.length !== 0) { %>
<div class="w-full">
  <div class="m-auto h-full w-full max-w-[1280px] px-4 py-10 lg:px-10 lg:py-20">
    <div class="flex items-end justify-between pb-6 lg:pb-10">
      <h3 class="text-2xl font-semibold lg:text-[36px]">
        <p>서비스</p>
        <p>성공 사례</p>
      </h3>
      <div class="flex-none">
        <button id="resultsBtn" class="cursor-pointer border border-black bg-white px-6 py-3 text-xs font-semibold">
          전체보기
        </button>
      </div>
    </div>
    <div class="lg:pl-50">
      <div class="grid grid-cols-1 items-center justify-center gap-2 lg:grid-cols-2 lg:gap-4">
      <% data.midBanner3.forEach((banner) => { %>
        <div>
          <div class="h-[200px] w-full lg:h-[280px]">
            <img
              src="<%=banner.imagePath%>"
              alt="<%=banner.title%>"
              class="h-full w-full object-cover"
            />
          </div>
          <div class="space-y-1 py-3 text-center">
            <p class="font-['Oswald'] text-2xl font-semibold text-cyan-800"><%=banner.description%></p>
            <p class="text-base font-semibold text-zinc-500"><%=banner.title%></p>
          </div>
        </div>
      <% }) %>
      </div>
    </div>
  </div>
</div>
<% } %>

<!-- 문의 폼 -->
<div class="w-full">
  <div class="m-auto h-full w-full max-w-[1280px] border-t border-black px-4 py-10 lg:px-10 lg:py-20">
    <div class="flex flex-col justify-between pb-10 lg:flex-row lg:items-end">
      <h3 class="mb-4 text-2xl font-semibold lg:mb-0 lg:text-[36px]">
        <p>온라인 상담</p>
      </h3>
      <div class="flex-none">
        <p class="text-sm font-semibold lg:text-lg">양식을 작성해 보내주시면 최대한 빨리 연락드리겠습니다.</p>
      </div>
    </div>
    <div class="lg:pl-50">
      <form id="formContact" action="" class="space-y-4">
        <!-- 이름 -->
        <div class="space-y-2 text-sm">
          <div class="text-sm font-medium">
            <label for="name">이름</label>
            <span class="text-rose-500">*</span>
          </div>
          <input
            type="text"
            id="name"
            name="name"
            class="w-full rounded-full border border-zinc-400 px-4 py-2 font-semibold placeholder:text-zinc-400 focus:ring-2 focus:ring-sky-500 focus:outline-none"
            placeholder="이름을 입력해주세요."
            required
          />
        </div>
        <!-- 이메일 -->
        <div class="space-y-2 text-sm">
          <div class="text-sm font-medium">
            <label for="email">이메일</label>
            <span class="text-rose-500">*</span>
          </div>
          <input
            type="email"
            id="email"
            name="email"
            class="w-full rounded-full border border-zinc-400 px-4 py-2 font-semibold placeholder:text-zinc-400 focus:ring-2 focus:ring-sky-500 focus:outline-none"
            placeholder="이메일을 입력해주세요."
            required
          />
        </div>
        <!-- 연락처 -->
        <div class="space-y-2 text-sm">
          <div class="text-sm font-medium">
            <label for="phone">연락처</label>
          </div>
          <input
            type="text"
            id="phone"
            name="phone"
            class="w-full rounded-full border border-zinc-400 px-4 py-2 font-semibold placeholder:text-zinc-400 focus:ring-2 focus:ring-sky-500 focus:outline-none"
            placeholder="연락처를 입력해주세요."
          />
        </div>
        <!-- 업무분야 -->
        <div class="space-y-2 text-sm">
          <div class="text-sm font-medium">
            <label for="subject">업무분야</label>
          </div>
          <div class="rounded-full border border-zinc-400">
            <select
              name="subject"
              id="subject"
              class="w-full rounded-full border-r-12 border-transparent px-4 py-2 font-semibold placeholder:text-zinc-400 focus:ring-2 focus:ring-sky-500 focus:outline-none"
            >
              <option value="">업무분야를 선택해주세요.</option>
              <option value="치명적 상해사고">치명적 상해사고</option>
              <option value="대형 교통사고">대형 교통사고</option>
              <option value="의료사고">의료사고</option>
              <option value="보행자 및 자전거 사고">보행자 및 자전거 사고</option>
              <option value="구내 상해사고">구내 상해사고</option>
              <option value="개에게 물림 사고">개에게 물림 사고</option>
              <option value="제조물 책임">제조물 책임</option>
              <option value="기타">기타</option>
            </select>
          </div>
        </div>
        <!-- 내용 -->
        <div class="space-y-2 text-sm">
          <div class="text-sm font-medium">
            <label for="content">상담 내용</label>
            <span class="text-rose-500">*</span>
          </div>
          <textarea
            id="content"
            name="content"
            class="min-h-[160px] w-full rounded-xl border border-zinc-400 px-4 py-2 font-semibold placeholder:text-sm placeholder:text-zinc-400 focus:ring-2 focus:ring-sky-500 focus:outline-none"
            placeholder="상담하실 내용을 작성해주세요."
            required
          ></textarea>
        </div>
        <!-- 전송 -->
        <div class="text-center">
          <button type="submit" class="cursor-pointer border border-black bg-white px-6 py-3 text-xs font-semibold">
            상담 신청
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- swiper -->
<link rel="stylesheet" href="/js/swiper@11/swiper-bundle.min.css" />
<script src="/js/swiper@11/swiper-bundle.min.js"></script>

<script nonce="<%=nonce%>">
  document.addEventListener("DOMContentLoaded", () => {
    // 상수 정의
    const POPUP_SHOWN_KEY = 'popup_shown';
    const bannerData = `<%-JSON.stringify(data.popupBanner)%>`;
    const popupBanners = bannerData ? JSON.parse(bannerData) : [];
    const popupContainer = document.getElementById('popupContainer');

    // 로컬스토리지 유틸리티
    const storage = {
      get: (key) => JSON.parse(localStorage.getItem(key)),
      set: (key, value) => localStorage.setItem(key, JSON.stringify(value))
    };

    // 유틸리티 함수
    const hideElement = (element) => element?.classList.add('hidden');
    const showElement = (element) => element?.classList.remove('hidden');

    // 만료일자 체크 함수
    const isExpired = (expireDate) => {
      if (!expireDate) return true;
      return new Date() > new Date(expireDate);
    };

    // 팝업 필터링
    const getCheckedPopups = () => {
      const popupShown = storage.get(POPUP_SHOWN_KEY) || {};
      // 오늘 하루 보지 않기 체크한 팝업이 만료되었거나 체크 안한 팝업만 필터링
      return popupBanners.filter(popup => !popupShown[popup.id] || isExpired(popupShown[popup.id]));
    };

    // 팝업 초기 설정
    const initPopups = () => {
      const uncheckedPopups = getCheckedPopups();

      if (uncheckedPopups.length === 0) {
        hideElement(popupContainer);
        return;
      }

      showElement(popupContainer);
      uncheckedPopups.forEach(popup => {
        const popupElement = document.getElementById(`popupBanner${popup.id}`);
        showElement(popupElement);
      });
    };

    // 팝업 닫기 처리
    const closePopup = (popupId) => {
      hideElement(document.getElementById(`popupBanner${popupId}`));

      const remainingPopups = getCheckedPopups().filter(popup => popup.id !== Number(popupId));
      if (remainingPopups.length === 0) {
        hideElement(popupContainer);
      }
    };

    // 오늘 하루 보지 않기 처리
    const setPopupExpire = (popupId) => {
      const popupShown = storage.get(POPUP_SHOWN_KEY) || {};
      const expireDate = new Date();
      expireDate.setDate(expireDate.getDate() + 1);
      popupShown[popupId] = expireDate.toISOString();
      storage.set(POPUP_SHOWN_KEY, popupShown);
    };

    // 이벤트 핸들러
    const handleCloseClick = (e) => {
      const popupId = e.target.closest('[data-popup-id]').dataset.popupId;
      closePopup(popupId);
    };

    const handleCheckboxChange = (e) => {
      if (e.target.checked) {
        const popupId = e.target.closest('[data-popup-id]').dataset.popupId;
        setPopupExpire(popupId);
        closePopup(popupId);
      }
    };

    // 이벤트 리스너 등록
    const initEventListeners = () => {
      document.querySelectorAll('button.popup-close-btn').forEach(btn => {
        btn.addEventListener('click', handleCloseClick);
      });

      document.querySelectorAll('input#todayCheck').forEach(checkbox => {
        checkbox.addEventListener('change', handleCheckboxChange);
      });
    };

    // 초기화 실행
    initPopups();
    initEventListeners();
    
    // 버튼 클릭시 상담 페이지로 이동
    document.getElementById('contactBtn').addEventListener('click', () => {
      location.href = '<%=routes.contact.url%>';
    });
  
    // 버튼 클릭시 소개 페이지로 이동
    document.getElementById('aboutBtn').addEventListener('click', () => {
      location.href = '<%=routes.about.url%>';
    });
  
    // 버튼 클릭시 업무분야 페이지로 이동
    document.getElementById('servicesBtn').addEventListener('click', () => {
      location.href = '<%=routes.services.url%>';
    });
  
    // 버튼 클릭시 성공사례 페이지로 이동
    document.getElementById('resultsBtn').addEventListener('click', () => {
      location.href = '<%=routes.results.url%>';
    });
  
    // 스와이퍼 설정
    const mainServicesSwiper = new Swiper('#mainServices', {
      slidesPerView: 1.3,
      spaceBetween: 4,
      loop: true,
      autoplay: {
        delay: 3000,
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      // 1024px 이상일 때
      breakpoints: {
        1024: {
          slidesPerView: 3.3,
          spaceBetween: 4,
        },
      },
    });

    // 폼 데이터 전송
    document.getElementById('formContact').addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        // TODO: 폼 데이터 유효성 검사
        // isNonUserWrite, isEncrypt = true;

        // 폼 데이터 수집
        const formData = new FormData(e.target);
        
        // 폼 데이터 변환
        const data = {};
        formData.forEach((value, key) => {
          data[key] = value;
        });
        
        const formatData = {
          title: data.subject,
          content: `
            이름: ${data.name}<br>
            이메일: ${data.email}<br>
            연락처: ${data.phone}<br>
            업무분야: ${data.subject}<br>
            내용: ${data.content}
          `,
        };

        // 콘텐츠 저장 API 호출
        const groupId = '<%=metadata.content.group.id%>';
        const saveUrl = '<%=apiRoutes.contents.write.url%>'.replace(':groupId', groupId);

        const response = await fetch(saveUrl, {
          method: '<%=apiRoutes.contents.write.method%>',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formatData),
        });

        // 응답 오류
        if (!response.ok) {
          throw new Error('상담 신청에 실패하였습니다.');
        }

        // 응답 성공
        alert('상담 신청이 완료되었습니다. 빠른 시일 내에 연락드리겠습니다.');
      } catch (error) {
        alert('상담 신청에 실패하였습니다. 다시 시도해주세요.');
      }
    });
  });
</script>